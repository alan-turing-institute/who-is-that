{% extends "index.html" %}

{% block title %}
    Process File
{% endblock %}

{% block content %}
{% if cover_url %}
<img src="{{ cover_url }}" alt="EPUB Cover" class="image">
{% else %}
<h1>{{ title }}</h1>
<h2>{{ author }}</h2>
{% endif %}

<div class="book" id="text-content">
{% if html_user_content %}
    {{ html_user_content|safe }}
{% endif %}
</div>

<div id="dropdown">
    <ul>
        <li onclick="summarise('summary')">Summarise</li>
        <li onclick="summarise('who_is_that')">Who is that?</li>
        <li onclick="summarise('what_is_this')">What is that place?</li>
    </ul>
</div>

<form id="summary-form" method="POST" action="/summarise">
    <input type="hidden" name="selected_text" id="selected-text">
    <input type="hidden" name="selected_text_start" id="selected-text-start">
    <input type="hidden" name="concatenated_text" id="concatenated-text" value="{{ concatenated_text }}">
    <input type="hidden" name="author" id="author" value="{{ author }}">
    <input type="hidden" name="title" id="title" value="{{ title }}">
    <input type="hidden" name="option" id="option">
</form>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const textContent = document.getElementById("text-content");
    const dropdown = document.getElementById("dropdown");
    const selectedTextInput = document.getElementById("selected-text");
    const selectedTextStartInput = document.getElementById("selected-text-start");

    textContent.addEventListener("contextmenu", (event) => {
        event.preventDefault();
        const selectedRange = window.getSelection().getRangeAt(0);
        const selectedText = selectedRange.toString().trim();  // Trim leading and trailing whitespace

        // Strip HTML tags from the selected text
        const tempDiv = document.createElement("div");
        tempDiv.appendChild(selectedRange.cloneContents());
        const strippedText = tempDiv.innerText.trim();

        if (strippedText) {
            const preRange = document.createRange();
            preRange.selectNodeContents(textContent);
            preRange.setEnd(selectedRange.startContainer, selectedRange.startOffset);
            const selectedTextStart = preRange.toString().length;

            selectedTextInput.value = strippedText;
            selectedTextStartInput.value = selectedTextStart;
            dropdown.style.display = "block";
            dropdown.style.left = `${event.pageX}px`;
            dropdown.style.top = `${event.pageY}px`;
        } else {
            dropdown.style.display = "none";
        }
    });

    document.addEventListener("click", (event) => {
        if (!dropdown.contains(event.target)) {
            dropdown.style.display = "none";
        }
    });
});

function summarise(option) {
    document.getElementById("option").value = option;
    document.getElementById("summary-form").submit();
}
</script>
{% endblock %}
